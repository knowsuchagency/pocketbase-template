# Tool version management
[tools]
go = "1.24.4"
bun = "latest"
node = "latest"

# Environment configuration
[env]
_.file = ".env"

# Task definitions
[tasks.install-backend-deps]
description = "Install backend dependencies"
run = "go mod tidy"

[tasks.install-frontend-deps]
description = "Install frontend dependencies"
run = "cd frontend && bun install"

[tasks.install-deps]
description = "Install all dependencies (backend and frontend)"
depends = ["install-backend-deps", "install-frontend-deps"]

[tasks.init]
description = "Initialize the project"
depends = ["install-deps"]
file = "scripts/init.sh"

[tasks.dev-frontend]
description = "Run frontend dev server"
run = "cd frontend && bun run dev"

[tasks.dev-pb]
description = "Start the PocketBase development server"
run = "go run main.go serve --dev"

[tasks.dev]
description = "Run backend in dev mode (frontend should be run separately)"
run = 'npx concurrently --names "frontend,backend" --prefix-colors "cyan,magenta" "cd frontend && bun run dev" "go run main.go serve --dev"'

[tasks.build]
description = "Build backend only (frontend built separately for Cloudflare deployment)"
run = """
go build -o pocketbase main.go
cd frontend && bun run build
"""

[tasks.test-backend]
description = "Run backend tests"
run = "go test -v ./..."

[tasks.test-frontend]
description = "Run frontend tests"
run = "cd frontend && bun run test"

[tasks.test]
description = "Run all tests"
depends = ["test-backend", "test-frontend"]

[tasks.makemigration]
description = "Create a new database migration with the specified name"
run = 'echo "y" | go run . migrate create "{{arg(name="name")}}"'

[tasks.migrate]
description = "Run all pending database migrations"
run = "go run . migrate up"

[tasks.migratedown]
description = "Rollback the last database migration"
run = "go run . migrate down"

[tasks.update-deps]
description = "Update all dependencies to their latest versions"
run = """
go get -u ./...
go mod tidy
cd frontend && bun update --latest
"""

[tasks.update-pocketbase]
description = "Update PocketBase to the latest version"
run = """
go get github.com/pocketbase/pocketbase@latest
go mod tidy
"""

[tasks.check-updates]
description = "Check for available updates to all dependencies"
run = "go list -m -u all"

[tasks.show-collections]
description = "Show collections in a human and LLM readable format (use --hidden to include hidden collections)"
run = '''
#!/bin/bash
FLAGS=""
if [[ "{{flag(name="hidden")}}" == "true" ]]; then
    FLAGS="--show-hidden"
fi
go run cmd/show-collections.go show-collections $FLAGS 2>&1 | grep -v -E '^\[[0-9]+(\.[0-9]+)?ms\]'
'''

[tasks.reset]
description = "Reset the database"
run = """
#!/bin/bash
echo "⚠️  WARNING: This will permanently delete all database data!"
echo -n "Are you sure you want to reset the database? (y/N): "
read -r confirm
if [[ "$confirm" =~ ^[Yy]$ ]]; then
    rm -rf ./pb_data/*
    echo "✅ Database reset complete."
else
    echo "Reset cancelled."
fi
"""

[tasks.typecheck]
description = "Run TypeScript type checking"
run = "cd frontend && bun run typecheck"

[tasks.test-ui]
description = "Run Playwright tests with interactive UI"
run = "cd frontend && bun run test:ui"

[tasks.test-headed]
description = "Run Playwright tests in headed browser mode"
run = "cd frontend && bun run test:headed"

[tasks.test-debug]
description = "Debug Playwright tests interactively"
run = "cd frontend && bun run test:debug"

[tasks.test-report]
description = "Show HTML test report"
run = "cd frontend && bun run test:report"

[tasks.build-frontend]
description = "Build frontend for production"
run = "cd frontend && bun run build"

[tasks.preview-frontend]
description = "Preview frontend production build"
run = "cd frontend && bun run preview"

[tasks.deploy]
description = "Deploy frontend to Cloudflare Workers"
run = "cd frontend && bun run deploy"
